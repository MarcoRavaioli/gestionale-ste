<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Nuova Commessa</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="chiudi()">Annulla</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <div class="section-box">
    <div class="header-toggle">
      <h3><ion-icon name="location-outline"></ion-icon> Cantiere</h3>
    </div>

    <ion-item lines="none" class="ion-margin-bottom">
      <ion-toggle mode="ios" [(ngModel)]="usaCantiereGenerico" color="medium">
        Commessa Interna (Senza Cantiere)
      </ion-toggle>
    </ion-item>

    <div *ngIf="!usaCantiereGenerico" class="fade-in">
      <app-generic-selector 
        label="Cerca e seleziona Indirizzo Cantiere..."
        type="cantiere"
        [items]="listaCantieri"
        [(selectedId)]="selectedCantiereId">
      </app-generic-selector>

      <ion-button expand="block" fill="outline" class="ion-margin-top" (click)="creaNuovoCantiereAlVolo()">
        <ion-icon name="add" slot="start"></ion-icon>
        Crea Nuovo Cantiere
      </ion-button>
    </div>
  </div>

  <div class="section-box ion-margin-top">
    <h3><ion-icon name="documents-outline"></ion-icon> Dettagli Commessa</h3>
    
    <div class="form-grid">
      <ion-input label="Seriale (es. A123456) *" label-placement="floating" fill="outline" [(ngModel)]="commessa.seriale"></ion-input>
      <ion-textarea label="Descrizione Lavoro" label-placement="floating" fill="outline" rows="2" [(ngModel)]="commessa.descrizione"></ion-textarea>
      
      <div style="display: flex; gap: 10px;">
        <ion-input label="Valore Tot. (â‚¬)" type="number" label-placement="floating" fill="outline" [(ngModel)]="commessa.valore_totale"></ion-input>
        <ion-select label="Stato *" label-placement="floating" fill="outline" [(ngModel)]="commessa.stato">
          <ion-select-option value="APERTA">APERTA</ion-select-option>
          <ion-select-option value="IN_CORSO">IN CORSO</ion-select-option>
          <ion-select-option value="CHIUSA">CHIUSA</ion-select-option>
        </ion-select>
      </div>

      <div class="file-upload-section">
        <p class="section-subtitle">Allegato (Opzionale)</p>
        <input type="file" id="fileInputGlobal" (change)="onFileSelected($event)" style="display: none;">
        <div class="file-box" (click)="triggerFileInput()">
          <ion-icon name="cloud-upload-outline" *ngIf="!selectedFile"></ion-icon>
          <ion-icon name="document-attach-outline" *ngIf="selectedFile" color="primary"></ion-icon>
          <div class="file-info">
            <span class="filename">{{ selectedFile ? selectedFile.name : 'Tocca per caricare un file' }}</span>
            <span class="filesize" *ngIf="selectedFile">{{ (selectedFile.size / 1024 / 1024) | number:'1.2-2' }} MB</span>
          </div>
          <ion-button *ngIf="selectedFile" fill="clear" color="danger" (click)="rimuoviFile($event)">
            <ion-icon name="close-circle" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
      </div>
    </div>
  </div>

  <ion-button expand="block" class="ion-margin-top" size="large" (click)="salva()" [disabled]="!isValid()">
    CREA COMMESSA
  </ion-button>
</ion-content>