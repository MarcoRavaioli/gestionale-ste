<ion-header [translucent]="true" class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-title>Archivio</ion-title>
  </ion-toolbar>

  <div class="categories-header">
    <ion-chip
      [class.chip-active]="vistaCorrente === 'clienti'"
      (click)="cambiaVista('clienti')"
    >
      <ion-label>Committenti</ion-label>
    </ion-chip>

    <ion-chip
      [class.chip-active]="vistaCorrente === 'cantieri'"
      (click)="cambiaVista('cantieri')"
    >
      <ion-label>Indiriz. Cant.</ion-label>
    </ion-chip>

    <ion-chip
      [class.chip-active]="vistaCorrente === 'commesse'"
      (click)="cambiaVista('commesse')"
    >
      <ion-label>Commesse</ion-label>
    </ion-chip>

    <ion-chip
      [class.chip-active]="vistaCorrente === 'appuntamenti'"
      (click)="cambiaVista('appuntamenti')"
    >
      <ion-label>Appuntamenti</ion-label>
    </ion-chip>
  </div>

  <ion-toolbar color="primary">
    <div class="search-container">
      <ion-searchbar
        [placeholder]="getPlaceholder()"
        [(ngModel)]="ricerca"
        (ionInput)="elaboraDati()"
        animated="true"
        class="custom-searchbar"
      >
      </ion-searchbar>

      <ion-button fill="clear" color="light" (click)="apriImpostazioni($event)">
        <ion-icon slot="icon-only" name="filter-outline"></ion-icon>
      </ion-button>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="caricaDati($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div *ngIf="vistaCorrente === 'clienti'">
    <ion-list lines="none" class="custom-list">
      <ion-item
        *ngFor="let cliente of clientiVisualizzati"
        button
        detail="false"
        [routerLink]="['/cliente-dettaglio', cliente.id]"
        class="list-item"
      >
        <ion-avatar slot="start" class="item-avatar">
          <div class="avatar-placeholder">{{ cliente.nome.charAt(0) }}</div>
        </ion-avatar>
        <ion-label>
          <h2 class="item-title">{{ cliente.nome }}</h2>
          <p class="item-subtitle">{{ cliente.email || 'Nessuna email' }}</p>
        </ion-label>
        <ion-icon
          name="chevron-forward"
          slot="end"
          color="medium"
          class="arrow-icon"
        ></ion-icon>
      </ion-item>
    </ion-list>
    <div *ngIf="clientiVisualizzati.length === 0" class="empty-state">
      <ion-icon name="people-outline"></ion-icon>
      <p>Nessun cliente trovato.</p>
    </div>
  </div>

  <div *ngIf="vistaCorrente === 'cantieri'">
    <ion-list lines="none" class="custom-list" *ngIf="!isCantieriGrouped">
      <ion-item
        *ngFor="let cantiere of cantieriLista"
        button
        detail="false"
        [routerLink]="['/cliente-dettaglio', cantiere.cliente?.id]"
        [queryParams]="{ cantiereId: cantiere.id }"
        class="list-item"
      >
        <div slot="start" class="list-icon-box box-secondary">
          <ion-icon name="location"></ion-icon>
        </div>
        <ion-label>
          <ion-note class="mini-tag">{{ cantiere.citta | uppercase }}</ion-note>
          <h2 class="item-title">{{ cantiere.via }} {{ cantiere.civico }}</h2>
          <p class="item-subtitle highlight-text">
            {{ cantiere.cliente?.nome }}
          </p>
        </ion-label>
        <ion-icon
          name="chevron-forward"
          slot="end"
          color="medium"
          class="arrow-icon"
        ></ion-icon>
      </ion-item>
    </ion-list>

    <ion-list lines="none" class="custom-list" *ngIf="isCantieriGrouped">
      <ion-item-group *ngFor="let gruppo of cantieriGruppi">
        <ion-item-divider sticky="true" class="custom-divider">
          <ion-label>{{ gruppo.nome | uppercase }}</ion-label>
        </ion-item-divider>
        <ion-item
          *ngFor="let item of gruppo.items"
          button
          detail="false"
          [routerLink]="['/cliente-dettaglio', item.cliente?.id]"
          class="list-item"
        >
          <div slot="start" class="list-icon-box box-secondary">
            <ion-icon name="location"></ion-icon>
          </div>
          <ion-label>
            <h2 class="item-title">{{ item.via }} {{ item.civico }}</h2>
            <p class="item-subtitle">{{ item.cliente?.nome }}</p>
          </ion-label>
        </ion-item>
      </ion-item-group>
    </ion-list>
    <div
      *ngIf="cantieriLista.length === 0 && cantieriGruppi.length === 0"
      class="empty-state"
    >
      <ion-icon name="business-outline"></ion-icon>
      <p>Nessun cantiere trovato.</p>
    </div>
  </div>

  <div *ngIf="vistaCorrente === 'commesse'">
    <ion-list lines="none" class="custom-list" *ngIf="!isCommesseGrouped">
      <ion-item
        *ngFor="let item of commesseLista"
        button
        detail="false"
        [routerLink]="['/cliente-dettaglio', item.indirizzo?.cliente?.id]"
        [queryParams]="{ cantiereId: item.indirizzo?.id, commessaId: item.id }"
        class="list-item"
      >
        <div slot="start" class="list-icon-box box-tertiary">
          <ion-icon name="documents"></ion-icon>
        </div>
        <ion-label>
          <div class="meta-row">
            <div style="display: flex; align-items: center; gap: 8px">
              <span class="serial-code">{{ item.seriale }}</span>

              <ion-icon
                *ngIf="item.allegati && item.allegati.length > 0"
                name="attach-outline"
                color="primary"
                style="
                  font-size: 1.4rem;
                  transform: rotate(45deg);
                  filter: drop-shadow(0px 2px 2px rgba(0, 0, 0, 0.1));
                "
              >
              </ion-icon>
            </div>

            <ion-badge
              [color]="getColoreStato(item.stato)"
              class="status-badge"
            >
              {{ item.stato }}
            </ion-badge>
          </div>
          <h2 class="item-title">
            {{ item.descrizione || 'Nessuna descrizione' }}
          </h2>
          <p class="item-subtitle icon-text">
            <ion-icon name="person-outline"></ion-icon>
            {{ item.indirizzo?.cliente?.nome }}
            <span *ngIf="item.indirizzo" class="sub-location">
              â€¢ {{ item.indirizzo.citta }}</span
            >
          </p>
        </ion-label>
        <ion-icon
          name="chevron-forward"
          slot="end"
          color="medium"
          class="arrow-icon"
        ></ion-icon>
      </ion-item>
    </ion-list>

    <ion-list lines="none" class="custom-list" *ngIf="isCommesseGrouped">
      <ion-item-group *ngFor="let gruppo of commesseGruppi">
        <ion-item-divider sticky="true" class="custom-divider">
          <ion-label>{{ gruppo.nome }} ({{ gruppo.items.length }})</ion-label>
        </ion-item-divider>
        <ion-item
          *ngFor="let item of gruppo.items"
          button
          detail="false"
          [routerLink]="['/cliente-dettaglio', item.indirizzo?.cliente?.id]"
          class="list-item"
        >
          <div slot="start" class="list-icon-box box-tertiary">
            <ion-icon name="documents"></ion-icon>
          </div>
          <ion-label>
            <div
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                width: 100%;
              "
            >
              <h3 class="item-title" style="margin: 0; flex: 1">
                {{ item.seriale }} - {{ item.indirizzo?.cliente?.nome }}
              </h3>

              <ion-icon
                *ngIf="item.allegati && item.allegati.length > 0"
                name="attach-outline"
                color="primary"
                style="
                  font-size: 1.3rem;
                  transform: rotate(45deg);
                  margin-left: 8px;
                "
              >
              </ion-icon>
            </div>
            <p class="item-subtitle" style="margin-top: 4px">
              {{ item.descrizione }}
            </p>
          </ion-label>
        </ion-item>
      </ion-item-group>
    </ion-list>

    <div
      *ngIf="(isCommesseGrouped ? commesseGruppi.length : commesseLista.length) === 0"
      class="empty-state"
    >
      <ion-icon name="folder-open-outline"></ion-icon>
      <p>Nessuna commessa trovata.</p>
    </div>
  </div>

  <div *ngIf="vistaCorrente === 'appuntamenti'">
    <ion-list lines="none" class="custom-list" *ngIf="!isAppuntamentiGrouped">
      <ion-item
        *ngFor="let app of appuntamentiLista"
        button
        detail="false"
        [routerLink]="['/cliente-dettaglio', app.commessa?.indirizzo?.cliente?.id]"
        [queryParams]="{ 
          cantiereId: app.commessa?.indirizzo?.id, 
          commessaId: app.commessa?.id, 
          appuntamentoId: app.id 
        }"
        class="list-item"
      >
        <div slot="start" class="list-icon-box box-warning">
          <ion-icon name="calendar"></ion-icon>
        </div>
        <ion-label>
          <ion-note class="date-note">
            {{ app.data_ora | date:'dd/MM/yyyy HH:mm' }}
          </ion-note>

          <h2 class="item-title ion-text-wrap">
            {{ app.descrizione || app.nome }}
          </h2>

          <div class="details-block">
            <div class="detail-row">
              <ion-icon name="location-outline"></ion-icon>
              <span>
                {{ app.commessa?.indirizzo?.via || 'Via N.D.' }}, {{
                app.commessa?.indirizzo?.citta }}
              </span>
            </div>

            <div class="detail-row">
              <ion-icon name="documents-outline"></ion-icon>
              <span class="truncate-text">
                {{ app.commessa?.descrizione || 'Nessuna nota commessa' }}
              </span>
            </div>
          </div>
        </ion-label>
        <ion-icon
          name="chevron-forward"
          slot="end"
          color="medium"
          class="arrow-icon"
        ></ion-icon>
      </ion-item>
    </ion-list>

    <ion-list lines="none" class="custom-list" *ngIf="isAppuntamentiGrouped">
      <ion-item-group *ngFor="let gruppo of appuntamentiGruppi">
        <ion-item-divider sticky="true" class="custom-divider">
          <ion-label
            >{{ gruppo.nome }}
            <span class="divider-count"
              >({{ gruppo.items.length }})</span
            ></ion-label
          >
        </ion-item-divider>
        <ion-item
          *ngFor="let app of gruppo.items"
          button
          detail="false"
          [routerLink]="['/cliente-dettaglio', app.commessa?.indirizzo?.cliente?.id]"
          class="list-item"
        >
          <div slot="start" class="list-icon-box box-warning">
            <ion-icon name="calendar"></ion-icon>
          </div>
          <ion-label>
            <ion-note class="date-note">
              {{ app.data_ora | date: (settingsAppuntamenti.groupBy === 'giorno'
              ? 'HH:mm' : 'dd/MM/yyyy HH:mm') }}
            </ion-note>
            <h3 class="item-title">{{ app.descrizione || app.nome }}</h3>
            <p class="item-subtitle">
              {{ app.commessa?.indirizzo?.via }} <br />
              <span class="italic-note">{{ app.commessa?.descrizione }}</span>
            </p>
          </ion-label>
        </ion-item>
      </ion-item-group>
    </ion-list>

    <div
      *ngIf="(isAppuntamentiGrouped ? appuntamentiGruppi.length : appuntamentiLista.length) === 0"
      class="empty-state"
    >
      <ion-icon name="calendar-number-outline"></ion-icon>
      <p>Nessun appuntamento trovato.</p>
    </div>
  </div>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button
      *ngIf="vistaCorrente === 'clienti'"
      (click)="apriNuovoCliente()"
    >
      <ion-icon name="person-add-outline"></ion-icon>
    </ion-fab-button>
    <ion-fab-button
      *ngIf="vistaCorrente === 'cantieri'"
      (click)="apriNuovoCantiere()"
      color="secondary"
    >
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
    <ion-fab-button
      *ngIf="vistaCorrente === 'commesse'"
      (click)="apriNuovaCommessa()"
      color="tertiary"
    >
      <ion-icon name="documents-outline"></ion-icon>
    </ion-fab-button>
    <ion-fab-button
      *ngIf="vistaCorrente === 'appuntamenti'"
      (click)="apriNuovoAppuntamento()"
      color="warning"
    >
      <ion-icon name="calendar-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
