<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/tab3"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ cliente?.nome }}</ion-title>

    <ion-buttons slot="end" *ngIf="hasManagerAccess">
      <ion-button *ngIf="!isEditing" (click)="abilitaModifica()">
        <ion-icon slot="icon-only" name="pencil-outline"></ion-icon>
      </ion-button>

      <ion-button *ngIf="isEditing" (click)="annullaModifica()" color="light">
        <ion-icon slot="icon-only" name="close-outline"></ion-icon>
      </ion-button>
      <ion-button *ngIf="isEditing" (click)="salvaModifica()" color="warning">
        <ion-icon slot="icon-only" name="save-outline"></ion-icon>
      </ion-button>

      <ion-button
        *ngIf="!isEditing"
        (click)="chiediConfermaCancellazione()"
        color="danger"
      >
        <ion-icon
          slot="icon-only"
          name="trash-outline"
          style="color: #ffcccc"
        ></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" *ngIf="cliente" class="light-bg">
  <div class="contact-card ion-margin">
    <div class="card-header">
      <h3>Dati Contatto</h3>
    </div>

    <div class="contact-grid">
      <div class="contact-item full-width" *ngIf="isEditing">
        <ion-input
          label="Nome Committente/Ragione Sociale"
          label-placement="stacked"
          fill="outline"
          [(ngModel)]="cliente.nome"
        ></ion-input>
      </div>

      <div class="contact-item">
        <div class="icon-box"><ion-icon name="mail-outline"></ion-icon></div>
        <div class="info-content" *ngIf="!isEditing">
          <label>Email</label>
          <span>{{ cliente.email || '-' }}</span>
        </div>
        <ion-input
          *ngIf="isEditing"
          label="Email"
          label-placement="stacked"
          fill="outline"
          [(ngModel)]="cliente.email"
        ></ion-input>
      </div>

      <div class="contact-item">
        <div class="icon-box"><ion-icon name="call-outline"></ion-icon></div>
        <div class="info-content" *ngIf="!isEditing">
          <label>Telefono</label>
          <span>{{ cliente.telefono || '-' }}</span>
        </div>
        <ion-input
          *ngIf="isEditing"
          label="Telefono"
          label-placement="stacked"
          fill="outline"
          [(ngModel)]="cliente.telefono"
        ></ion-input>
      </div>
    </div>
  </div>

  <div class="sites-section">
    <div class="section-header-row ion-padding-horizontal">
      <h3>Cantieri Operativi</h3>
      <ion-button
        *ngIf="hasManagerAccess"
        size="small"
        fill="solid"
        (click)="apriModalIndirizzo()"
      >
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        Nuovo
      </ion-button>
    </div>

    <div class="ion-padding-horizontal search-wrapper">
      <ion-searchbar
        placeholder="Cerca indirizzo cantiere, commessa..."
        [(ngModel)]="searchTerm"
        (ionInput)="filtraCantieri()"
        animated="true"
      >
      </ion-searchbar>
    </div>

    <div *ngIf="!indirizziVisualizzati?.length" class="empty-state">
      <ion-icon name="business-outline"></ion-icon>
      <p>Nessun indirizzo trovato.</p>
    </div>

    <ion-accordion-group
      expand="inset"
      class="custom-accordion"
      [multiple]="true"
      [value]="indirizziAperti"
    >
      <ion-accordion
        *ngFor="let indirizzo of indirizziVisualizzati"
        [value]="indirizzo.id.toString()"
        [id]="'cantiere-' + indirizzo.id"
      >
        <ion-item
          slot="header"
          [id]="'cantiere-header-' + indirizzo.id"
          lines="none"
          class="accordion-header-item"
        >
          <div class="site-header-content">
            <div class="site-icon">
              <ion-icon name="location" color="secondary"></ion-icon>
            </div>

            <div class="site-info">
              <h2 class="site-address">
                {{ indirizzo.via }} {{ indirizzo.civico }}
              </h2>
              <p class="site-city">
                {{ indirizzo.citta }}
                <span *ngIf="indirizzo.provincia"
                  >({{ indirizzo.provincia }})</span
                >
              </p>
              <div class="site-badges">
                <ion-badge color="light" class="small-badge">
                  {{ indirizzo.commesse?.length || 0 }} Commesse
                </ion-badge>
              </div>
            </div>
          </div>
        </ion-item>

        <div slot="content" class="accordion-content-box">
          <div class="cantiere-actions-bar" *ngIf="hasManagerAccess">
            <span class="actions-label">Gestione Indirizzo</span>
            <div class="actions-buttons">
              <ion-button
                fill="clear"
                size="small"
                color="medium"
                (click)="apriModalIndirizzo(indirizzo)"
              >
                <ion-icon name="pencil-outline" slot="start"></ion-icon>
              </ion-button>
              <ion-button
                fill="clear"
                size="small"
                color="danger"
                (click)="eliminaIndirizzo(indirizzo)"
              >
                <ion-icon name="trash-outline" slot="start"></ion-icon>
              </ion-button>
            </div>
          </div>

          <app-indirizzo-accordion
            [indirizzo]="indirizzo"
            [hasManagerAccess]="hasManagerAccess"
            [targetCommessaId]="targetCommessaId"
            [targetAppuntamentoId]="targetAppuntamentoId"
            (onAddCommessa)="apriModalCommessa($event)"
            (onEditCommessa)="apriModalCommessa(indirizzo.id, $event)"
            (onDeleteCommessa)="eliminaCommessa($event)"
          >
          </app-indirizzo-accordion>
        </div>
      </ion-accordion>
    </ion-accordion-group>
  </div>

  <div class="spacer" style="height: 100px"></div>
</ion-content>